<!DOCTYPE html>
<html manifest="cache.manifest" lang="en">
	<head>
		<meta charset="utf-8" />
		<title id="title">StrainFinder</title>
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="default" />
		<meta name="viewport" content="user-scalable=no, width=device-width" />
		<meta name="apple-mobile-web-app-title" content="StrainFinder" />
		<link rel="icon" type="image/x-icon" href="favicon.ico" />
		<link rel="manifest" href="manifest.webmanifest" />
		<link rel="canonical" href="https://maxvalue.github.io/Terpene-Parser-Testing/" />
		<meta name="Description" content="Compare terpene profiles of cannabis strains using lab test data. Find out which compounds of your favourite strain affect your body." />
		<meta property="og:url" id="ogurl" content="https://maxvalue.github.io/Terpene-Parser-Testing/" />
		<meta property="og:title" id="ogtitle" content="StrainFinder" />
		<meta property="og:description" content="Compare terpene profiles of cannabis strains using lab test data. Find out which compounds of your favourite strain affect your body." />
		<meta property="og:image" content="https://maxvalue.github.io/Terpene-Profile-Parser-for-Cannabis-Strains/img/opengraph-icon-1200x1200.png" />
		<link rel="apple-touch-icon" sizes="120x120" href="img/apple-touch-icon-120x120.png" />
		<link rel="apple-touch-icon" sizes="152x152" href="img/apple-touch-icon-152x152.png" />
		<link rel="apple-touch-icon" sizes="167x167" href="img/apple-touch-icon-167x167.png" />
		<link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon-180x180.png" />
		<link rel="apple-touch-icon" sizes="1200x1200" href="img/apple-touch-icon.png" />
		<link rel="apple-touch-icon" href="img/apple-touch-icon.png" />
		<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" />
		<script id="jsonloader" type="text/javascript" src="results.json"></script>
		<link rel="stylesheet" type="text/css" href="https://maxvalue.github.io/Strudler/style.css">
		<style type="text/css">
			:root {
				--accentColor: var(--SystemGreen);
			}
/* 			#searchform {
				display: flex;
				flex-wrap: wrap;
				width: auto;
			}
			#searchform > * {
				flex: 1;
			}
			#searchwrapper {
				margin-right: 5.6px;
			}
			#sampleTypes, #databases {
				list-style-type: none;
				padding-left: 0;
			}
 */			.bargraph {
				display: inline-block;

				width: calc(100% - 2em);

				border-top: 0.5px solid #CCC;
				border-collapse: collapse;

				white-space: nowrap;
				font-size: 10px;
				color: #cbcbcb;
				margin: 1em;
			}
			.bargraph td {
				padding: 0;
				line-height: 10px;
			}
			.bargraph td div {
				min-width: 7px;
				/* min-height: 7px; */
				min-height: calc(1em - 2px);
				border-radius: 3.5px;
				box-shadow: 0 0 1px #FFF;
			}
			.bargraph tr + tr {
				border-top: 1px dashed #ebebeb;
			}
			.bargraph tr td:nth-of-type(1) {
				padding-right: 1em;
				line-height: 1em;
			}
			.bargraph tr td:nth-of-type(2) {
				width: 99%;
				background-image: linear-gradient(
										to right,
										#0000,
										#0000 10%,
										#dfdfdf 10%,/*dfdfdf,ececec,c7c7cb*/
										#dfdfdf 10.2%,
										#0000 10.2%,
										#0000 20%,
										#dfdfdf 20%,
										#dfdfdf 20.2%,
										#0000 20.2%,
										#0000 30%,
										#dfdfdf 30%,
										#dfdfdf 30.2%,
										#0000 30.2%,
										#0000 40%,
										#dfdfdf 40%,
										#dfdfdf 40.2%,
										#0000 40.2%,
										#0000 50%,
										#dfdfdf 50%,
										#dfdfdf 50.2%,
										#0000 50.2%,
										#0000 60%,
										#dfdfdf 60%,
										#dfdfdf 60.2%,
										#0000 60.2%,
										#0000 70%,
										#dfdfdf 70%,
										#dfdfdf 70.2%,
										#0000 70.2%,
										#0000 80%,
										#dfdfdf 80%,
										#dfdfdf 80.2%,
										#0000 80.2%,
										#0000 90%,
										#dfdfdf 90%,
										#dfdfdf 90.2%,
										#0000 90.2%
									);
			}
			.table-grouped>section + *:not(footer) {
				margin-top: 2em;
			}
			#about {
				clear: left;
			}
			#appversion {
				margin-left: 20px;
				float: right;
				color: #C7C7CC;
			}
		</style>
	</head>
	<body ontouchstart="">
		<div id="viewport">
			<form id="searchform" action="." onsubmit="return load_sample_data(this);">
				<div id="searchwrapper">
					<input type="submit" value="Search"><br>

					<label for="search">Strain Name:</label>
					<input type="search" name="q" id="search" inputmode="search" placeholder="Chocolope" autofocus="" oninput="load_sample_data(this.form);"><br>
					<div class="table-grouped">
						<header>Search Parameters</header>
						<section>
							<div class="table-cell">
								Exact Match?
								<input class="UIKit-UISwitch" type="checkbox" name="exact" id="exactmatch" value="1">
							</div>
							<div class="table-cell">
								Include Processed?
								<input class="UIKit-UISwitch" type="checkbox" name="processed" id="proccessedtoo" value="1">
							</div>
						</section>
					</div>
					<input type="submit" value="Search">
				</div>
				<output name="resultswrapper" for="search exactmatch sampleTypes databases"></output>
			</form>
			<div id="about">
				<a id="infolink" href="https://github.com/MaxValue/Terpene-Profile-Parser-for-Cannabis-Strains#terpene-profile-parser-for-cannabis-strains">Learn more about this project here</a>.</span>
				<span id="appversion">v2019-06-10T17:51:00+02:00/002</span>
			</div>
		</div>
		<template id="templateResults">
			<div class="UIKit-UISegmentedControl" onchange="sortTable()"
				><label
					><input type="radio" name="sortorder" value="default" checked=""
					><div title="Sort by Default Order">Default</div
				></label
				><label
					><input type="radio" name="sortorder" value="average"
					><div title="Sort by Average Descending">Average &#9660;</div
				></label
				><label
					><input type="radio" name="sortorder" value="variance"
					><div title="Sort by Variance Descending">Variance &sigma;&sup2; &#9660;</div
				></label
				><label
					><input type="radio" name="sortorder" value="stability"
					><div title="Sort by Stability Descending">Stability &#9660;</div
				></label
			></div>
			<div class="table-grouped">
				<header>Terpenes</header>
				<section>
					<table class="bargraph" id="results">
						<tbody></tbody>
					</table>
				</section>
				<footer id="results-terpenes-caption"></footer>
			</div>
		</template>
		<template id="templateResultsRow">
			<tr>
				<td></td><td><div></div></td>
			</tr>
		</template>
	</body>
	<script type="text/javascript">
		/*
		TODO:
			mobile friendly
			simple
			most relevant to least relevant

			big search field
			terpenes sort by most important ones
		*/
		var terpenes = [
			{
				id: "Terpinolene",
				name: "Terpinolene",
				effects: "",
				color: 0xB00000, // dark red
				boilingPoint: NaN,
				onsetTime: 0
			},
			{
				id: "betaOcimene",
				name: "beta-Ocimene",
				effects: "",
				color: 0xFF6519, // orange
				boilingPoint: NaN,
				onsetTime: 0
			},
			{
				id: "delta3Carene",
				name: "3-Carene",
				effects: "",
				color: 0xFF8C1A, // brighter orange
				boilingPoint: 168.0,
				onsetTime: 0
			},
			{
				id: "deltaLimonene",
				name: "delta-Limonene",
				effects: "",
				color: 0xFFD819, // yellow
				boilingPoint: 177.0,
				onsetTime: 0
			},
			{
				id: "gammaTerpinene",
				name: "gamma-Terpinene",
				effects: "",
				color: 0xA7CF58, // light green
				boilingPoint: NaN,
				onsetTime: 0
			},
			{
				id: "alphaPinene",
				name: "alpha-Pinene",
				effects: "",
				color: 0x68CF55, // green
				boilingPoint: 156.0,
				onsetTime: 0
			},
			{
				id: "alphaTerpinene",
				name: "alpha-Terpinene",
				effects: "",
				color: 0x379767, // darker green
				boilingPoint: NaN,
				onsetTime: 0
			},
			{
				id: "betaPinene",
				name: "beta-Pinene",
				effects: "",
				color: 0x008647, // darkest green
				boilingPoint: NaN,
				onsetTime: 0
			},
			{
				id: "Camphene",
				name: "Camphene",
				effects: "",
				color: 0x64A7B7, // grey blue
				boilingPoint: NaN,
				onsetTime: 0
			},
			{
				id: "alphaHumulene",
				name: "alpha-Humulene",
				effects: "",
				color: 0x009DE5, // mid blue
				boilingPoint: NaN,
				onsetTime: 0
			},
			{
				id: "betaCaryophyllene",
				name: "beta-Caryophyllene",
				effects: "",
				color: 0x4667CA, // dark blue
				boilingPoint: 119.0,
				onsetTime: 0
			},
			{
				id: "Linalool",
				name: "Linalool",
				effects: "",
				color: 0x9366F1, // violet
				boilingPoint: 198.0,
				onsetTime: 0
			},
			{
				id: "CaryophylleneOxide",
				name: "Caryophyllene Oxide",
				effects: "",
				color: 0x510F3A, // dark purple
				boilingPoint: NaN,
				onsetTime: 0
			},
			{
				id: "betaMyrcene",
				name: "beta-Myrcene",
				effects: "",
				color: 0x9E2576, // purple
				boilingPoint: 167.0,
				onsetTime: 0
			},
			{
				id: "cisNerolidol",
				name: "cis-Nerolidol",
				effects: "",
				color: 0xC7C7CC, // gray
				boilingPoint: NaN,
				onsetTime: 0
			},
			{
				id: "transNerolidol",
				name: "trans-Nerolidol",
				effects: "",
				color: 0xC7C7CC, // gray
				boilingPoint: NaN,
				onsetTime: 0
			},
			{
				id: "transNerolidol1",
				name: "trans-Nerolidol 1",
				effects: "",
				color: 0xC7C7CC, // gray
				boilingPoint: NaN,
				onsetTime: 0
			},
			{
				id: "transNerolidol2",
				name: "trans-Nerolidol 2",
				effects: "",
				color: 0xC7C7CC, // gray
				boilingPoint: NaN,
				onsetTime: 0
			},
			{
				id: "transOcimene",
				name: "trans-Ocimene",
				effects: "",
				color: 0xC7C7CC, // gray
				boilingPoint: NaN,
				onsetTime: 0
			},
			{
				id: "Eucalyptol",
				name: "Eucalyptol",
				effects: "",
				color: 0xC7C7CC, // gray
				boilingPoint: NaN,
				onsetTime: 0
			},
			{
				id: "Geraniol",
				name: "Geraniol",
				effects: "",
				color: 0xC7C7CC, // gray
				boilingPoint: NaN,
				onsetTime: 0
			},
			{
				id: "Guaiol",
				name: "Guaiol",
				effects: "",
				color: 0xC7C7CC, // gray
				boilingPoint: NaN,
				onsetTime: 0
			},
			{
				id: "Isopulegol",
				name: "Isopulegol",
				effects: "",
				color: 0xC7C7CC, // gray
				boilingPoint: NaN,
				onsetTime: 0
			},
			{
				id: "Ocimene",
				name: "Ocimene",
				effects: "",
				color: 0xC7C7CC, // gray
				boilingPoint: NaN,
				onsetTime: 0
			},
			{
				id: "alphaBisabolol",
				name: "alpha-Bisabolol",
				effects: "",
				color: 0xC7C7CC, // gray
				boilingPoint: NaN,
				onsetTime: 0
			},
			{
				id: "pCymene",
				name: "p-Cymene",
				effects: "",
				color: 0xC7C7CC, // gray
				boilingPoint: 177.0,
				onsetTime: 0
			}
		];
		// Hi there fellow code enthusiast!
		// You can change those values directly below, but please don't touch the others.
		var greyedOutColor = "#d9d9d9";
		var maxGraphPercentage = 1;
		var terpeneStabilityThreshold = 0.01;
		var FormatAverage = new Intl.NumberFormat('en',{style:'decimal',minimumFractionDigits:2,maximumFractionDigits:2});
		var FormatStability = new Intl.NumberFormat('en',{style:'percent',minimumFractionDigits:0,maximumFractionDigits:0});
		var FormatVariance = new Intl.NumberFormat('en',{style:'decimal',minimumFractionDigits:2,maximumFractionDigits:2});
		// That's it!

		var elem_pageCanonicalURL = document.querySelector("link[rel='canonical']");
		var baseURL = elem_pageCanonicalURL.href;

		var elem_pagetitle = document.getElementById("title");
		var elem_pageogtitle = document.getElementById("ogtitle");
		var elem_pageogurl = document.getElementById("ogurl");
		var elem_form = document.getElementById("searchform");
		// var elem_databaseList = document.getElementById("databases");
		// var elem_sampleTypes = document.getElementById("sampleTypes");
		var template_resultsTable = document.getElementById("templateResults");
		var template_resultsTableRow = document.getElementById("templateResultsRow");

		// var sampleTypes = [];
		var terpeneOrder = terpenes.map((terpene)=>terpene.id);

		function addDatabaseItem(identifier, label) {
			let databaseListItem = document.createElement("li");
			let databaseInput = document.createElement("input");
			let databaseLabel = document.createElement("label");
			databaseInput.type = "checkbox";
			databaseInput.name = "database";
			databaseInput.id = "database_" + identifier;
			databaseInput.value = identifier;
			databaseListItem.appendChild(databaseInput);
			databaseLabel.htmlFor = "database_" + identifier;
			databaseLabel.innerText = label;
			databaseListItem.appendChild(databaseLabel);
			elem_databaseList.appendChild(databaseListItem);
		}
		function addSampletype(sampleType) {
			if (!sampleTypes.includes(sampleType)) {
				let li = document.createElement("li");
				let input = document.createElement("input");
				let label = document.createElement("label");
				sampleTypes.push(sampleType);
				input.type = "checkbox";
				input.name = "type";
				input.id = "type_"+sampleType;
				input.value = sampleType;
				li.appendChild(input);
				label.htmlFor = "type_"+sampleType;
				label.innerText = sampleType;
				li.appendChild(label);
				elem_sampleTypes.appendChild(li);
			}
		}
		function hexColor(hexNumber) {
			return hexNumber.toString(16).padStart(7,"#000000");
		}
		function rgbaColor(hexNumber, alpha=1) {
			let hex = hexNumber.toString(16).padStart(6,"000000");
			let red = parseInt(hex.slice(0,2), 16);
			let green = parseInt(hex.slice(2,4), 16);
			let blue = parseInt(hex.slice(4,6), 16);
			return "rgba("+red+", "+green+", "+blue+", "+alpha+")";
		}
		function linearGradient(rawcolor, percentage, transparency) {
			let endColor = rgbaColor(rawcolor, transparency);
			return "linear-gradient(to right, "+endColor+", "+endColor+" "+percentage+"%, rgba(0,0,0,0) "+percentage+"%)";
		}
		function checkTypeCheckboxes() {
			let anyChecked = false;
			let unprocessedIndex = -1;
			elem_form.type.forEach(function(typeElem,typeIndex){
				if (typeElem.checked) {
					anyChecked = true;
				}
				if (typeElem.value == "Unprocessed") {
					unprocessedIndex = typeIndex;
				}
			})
			if (!anyChecked && unprocessedIndex!=-1) {
				elem_form.type[unprocessedIndex].checked = true;
			};
		}
		function checkDatabaseCheckboxes() {
			let anyChecked = false;
			elem_form.database.forEach(function(databaseElem){
				if (databaseElem.checked) {
					anyChecked = true;
				}
			})
			if (!anyChecked) {
				elem_form.database.forEach(function(databaseElem){
					databaseElem.checked = true;
				})
			};
		}
		function resetResults() {
			elem_pagetitle.text = "StrainFinder";
			elem_pageCanonicalURL.href = baseURL;
			elem_pageogurl.content = baseURL;
			elem_pageogtitle.content = "StrainFinder";
			elem_form.resultswrapper.innerHTML = "";
		}
		function sortTable() {
			var elem_resultsTable = document.getElementById("results");
			for (let tBody of elem_resultsTable.tBodies) {
				let rows = Array.from(tBody.rows);
				switch (elem_form.sortorder.value) {
					case "average":
						rows.sort((a,b)=>parseFloat(b.getAttribute("data-average")) - parseFloat(a.getAttribute("data-average")));
						break;
					case "stability":
						rows.sort((a,b)=>parseFloat(b.getAttribute("data-stability")) - parseFloat(a.getAttribute("data-stability")));
						break;
					case "variance":
						rows.sort((a,b)=>parseFloat(b.getAttribute("data-variance")) - parseFloat(a.getAttribute("data-variance")));
						break;
					case "default":
					default:
						rows.sort((a,b)=>terpeneOrder.indexOf(a.getAttribute("data-terpene")) - terpeneOrder.indexOf(b.getAttribute("data-terpene")));
						break;
				}
				tBody.innerHTML = "";
				rows.forEach(function(row){
					tBody.appendChild(row);
				});
			}
		}
		function load_sample_data(elem_form) {
			let searchResults = {}; // [terpene.name].avg; [terpene.name].variance
			let resultsNum = 0;
			let searchstring = elem_form.q.value.toLowerCase();
			let newURL = new URL(window.location);

			resetResults();

			newURL.search = "";
			if (elem_form.q.value != "") {
				newURL.searchParams.append(elem_form.q.name, elem_form.q.value);
			}
			if (elem_form.exact.checked) {
				newURL.searchParams.append(elem_form.exact.name, elem_form.exact.value);
			}
			// elem_form.type.forEach(function(typeCheckbox){
			// 	if (typeCheckbox.checked) {
			// 		newURL.searchParams.append(typeCheckbox.name, typeCheckbox.value);
			// 	}
			// })
			if (elem_form.processed.checked) {
				newURL.searchParams.append(elem_form.processed.name, elem_form.processed.value);
			}
			// elem_form.database.forEach(function(databaseCheckbox){
			// 	if (databaseCheckbox.checked) {
			// 		newURL.searchParams.append(databaseCheckbox.name, databaseCheckbox.value);
			// 	}
			// })
			window.history.pushState({},"",newURL);

			elem_pagetitle.text = "StrainFinder - '" + searchstring + "'";
			elem_pageCanonicalURL.href = newURL;
			elem_pageogurl.content = newURL;
			elem_pageogtitle.content = "StrainFinder: '" + searchstring + "'";

			for (const databaseName of Object.keys(databasesContainer.databases)) {
				let database = databasesContainer.databases[databaseName];
				let types = ["Unprocessed"];
				if (elem_form.processed.checked) {
					types.push('Processed');
				}
				types.forEach(function(typeName){
					if (typeName in database) {
						database[typeName].forEach(function(sample){
							let matched = false;
							if (elem_form.exact.checked) {
								if (sample["Sample Name"].toLowerCase() == searchstring) {
									matched = true
								}
							} else {
								if (sample["Sample Name"].toLowerCase().includes(searchstring)) {
									matched = true
								}
							}
							if (matched) {
								resultsNum ++;
								terpenes.forEach(function(terpene){
									let currentTerpeneValue = parseFloat(sample[terpene.name]) || 0.0;
									if (terpene.name in searchResults) {
										searchResults[terpene.name].avg += currentTerpeneValue;
										if (currentTerpeneValue > terpeneStabilityThreshold) {
											searchResults[terpene.name].stability ++;
										}
										searchResults[terpene.name].values.push(currentTerpeneValue);
									} else {
										searchResults[terpene.name] = {
											"avg": currentTerpeneValue,
											"stability": ( currentTerpeneValue>terpeneStabilityThreshold ? 1 : 0 ),
											"values": [currentTerpeneValue]
										};
									}
								});
							}
						})
					}
				})
			}

			if (resultsNum == 0) {
				elem_form.resultswrapper.innerText = "No results found";
			} else {
				var resultsStructure = document.importNode(template_resultsTable.content, true);
				var elem_resultsTable = resultsStructure.getElementById("results");
				var elem_resultsTableCaption = resultsStructure.getElementById("results-terpenes-caption");
				elem_resultsTableCaption.innerText = "Search Results for '"+searchstring+"' ("+resultsNum+" Sample"+(resultsNum==1?"":"s")+")";

				terpenes.forEach(function(terpene){
					searchResults[terpene.name].avg /= resultsNum;
				})
				terpenes.forEach(function(terpene){
					searchResults[terpene.name].stability /= resultsNum;
				})
				terpenes.forEach(function(terpene){
					let average = searchResults[terpene.name].avg;
					let sumSquaredDelta = 0;
					for (let individualValue of searchResults[terpene.name].values) {
						sumSquaredDelta += Math.pow(individualValue - average, 2);
					}
					searchResults[terpene.name].variance = sumSquaredDelta / resultsNum;
				})
				terpenes.forEach(function(terpene,terpeneIndex){
					let average = searchResults[terpene.name].avg;
					let stability = searchResults[terpene.name].stability;
					let variance = searchResults[terpene.name].variance;

					//table

					let row = document.importNode(templateResultsRow.content, true).children[0];
					row.setAttribute("data-average", average);
					row.setAttribute("data-stability", stability);
					row.setAttribute("data-variance", variance);
					row.setAttribute("data-terpene", terpene.id);

					////terpene name
					var cell = row.children[0];
					cell.innerText = terpene.name;
					if (average <= 0.01) {
						cell.style.color = greyedOutColor;
					}

					// graph
					// (overlay all datapoints of this terpene onto each other with a transparency set to 100%/resultsNum)
					var cell = row.children[1];
					var div = cell.children[0];

					if (average > 0.01) {
						div.style.backgroundColor = hexColor(terpene.color);
					} else {
						div.style.backgroundColor = greyedOutColor;
					}
					div.style.width = ((average/maxGraphPercentage)*100)+"%";

					// terpene amount
					// var cell = row.children[2];
					// var span = document.createElement("span");
					// span.innerText = FormatAverage.format(average);
					// if (average <= 0.01) {
					// 	cell.style.color = greyedOutColor;
					// }
					// cell.appendChild(span);

					////terpene variance
					// var cell = row.children[3];
					// cell.innerText = FormatVariance.format(variance);

					////terpene stability
					// var cell = row.children[4];
					// cell.innerText = FormatStability.format(stability);

					elem_resultsTable.tBodies[0].appendChild(row);
				})
				elem_form.resultswrapper.appendChild(resultsStructure);
			}
			return false;
		}

		// available databases list
		// for (const databaseName of Object.keys(databasesContainer.databases)) {
		// 	addDatabaseItem(databaseName, databaseName);
		// 	// sample type list
		// 	Object.keys(databasesContainer.databases[databaseName]).forEach(function(newSampleType){
		// 		addSampletype(newSampleType);
		// 	})
		// }
		let parsedURL = new URL(window.location);
		let doSearch = false;
		for (let param of parsedURL.searchParams) {
			let paramKey = param[0];
			let paramValue = param[1];
			switch (paramKey) {
				case "q":
					elem_form["q"].value = paramValue;
					doSearch = true;
					break;
				case "exact":
					if (paramValue=="1") {
						elem_form["exact"].checked = true;
						doSearch = true;
					}
					break;
				case "processed":
					if (paramValue=="1") {
						elem_form["processed"].checked = true;
						doSearch = true;
					}
					break;
				case "database":
					elem_form["database"].forEach(function(checkbox){
						if (checkbox.value == paramValue) {
							checkbox.checked = true;
							doSearch = true;
						}
					})
					break;
			}
		}
		// checkDatabaseCheckboxes();
		// checkTypeCheckboxes();
		if (doSearch) {
			load_sample_data(elem_form);
		}
	</script>
</html>
